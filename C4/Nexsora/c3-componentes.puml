@startuml C3-Componentes-Nexora
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Diagrama de Componentes - Gest√£o Completa de Dados Mestre + Pipeline AI

Container_Boundary(data_management_boundary, "Gest√£o de Dados Mestre") {
    Component(equipment_crud, "Equipment CRUD", "Python + FastAPI + SQLAlchemy", "Gerencia hierarquia de equipamentos e especifica√ß√µes")
    Component(equipment_validator, "Equipment Validator", "Python", "Valida dados e regras de neg√≥cio de equipamentos")
    Component(hierarchy_manager, "Hierarchy Manager", "Python", "Gerencia √°rvore hier√°rquica (Planta ‚Üí Linha ‚Üí Equipamento)")
    
    Component(sensor_crud, "Sensor CRUD", "Python + FastAPI + SQLAlchemy", "Gerencia tipos de sensores e especifica√ß√µes")
    Component(sensor_registry, "Sensor Registry", "Python", "Registro global de sensores para reutiliza√ß√£o")
    Component(sensor_validator, "Sensor Validator", "Python", "Valida limites operacionais e configura√ß√µes")
    
    Component(manual_crud, "Manual CRUD", "Python + FastAPI", "Gerencia uploads e metadados de manuais")
    Component(fmea_manager, "FMEA Manager", "Python", "Gerencia an√°lises FMEA (Failure Mode Effect Analysis)")
    Component(document_uploader, "Document Uploader", "Python + FastAPI", "Upload seguro de PDFs e documentos")
    
    Component(maintenance_crud, "Maintenance History CRUD", "Python + FastAPI", "Registra hist√≥rico completo de manuten√ß√µes")
    Component(failure_analyzer, "Failure Pattern Analyzer", "Python + pandas", "Analisa padr√µes de falha e correla√ß√µes")
    Component(roi_calculator, "ROI Calculator", "Python", "Calcula ROI de manuten√ß√µes e predi√ß√µes")
}

Container_Boundary(document_processing_boundary, "Processamento Inteligente de Documentos") {
    Component(pdf_processor, "PDF Processor", "Python + PyPDF2 + OCR", "Extrai texto de PDFs e imagens")
    Component(text_extractor, "Text Extractor", "Python + spaCy", "Extrai procedimentos e informa√ß√µes estruturadas")
    Component(entity_recognizer, "Entity Recognizer", "Python + NER", "Identifica pe√ßas, ferramentas e procedimentos")
    Component(document_classifier, "Document Classifier", "Python + scikit-learn", "Classifica tipos de documento automaticamente")
    Component(embedding_generator, "Embedding Generator", "Python + SentenceTransformers", "Gera embeddings contextuais")
    Component(knowledge_indexer, "Knowledge Indexer", "Python + LangChain", "Indexa conhecimento para RAG")
}

Container_Boundary(ingestion_boundary, "Entrada e Coordena√ß√£o") {
    Component(data_receiver, "Data Receiver", "Python + FastAPI", "Recebe dados de sensores via MQTT/HTTP")
    Component(sensor_validator_runtime, "Runtime Sensor Validator", "Python", "Valida sensores em tempo real contra registry")
    Component(data_processor, "Data Processor", "Python", "Processa, normaliza e valida dados de telemetria")
    Component(timeseries_writer, "TimeSeries Writer", "Python + InfluxDB Client", "Persiste dados tratados no banco time series")
    Component(observer, "Observador", "Python + Observer Pattern", "Observa mudan√ßas nos dados e emite eventos")
    Component(event_router, "Event Router", "Python + Pika", "Roteia eventos para filas espec√≠ficas")
}

Container_Boundary(trigger_boundary, "Trigger Manager - Configur√°vel pelo Usu√°rio") {
    Component(trigger_configurator, "Trigger Configurator", "Python + FastAPI", "Interface para configurar triggers de an√°lise preditiva")
    Component(scheduled_trigger, "Scheduled Trigger", "Python + Celery Beat", "Executa an√°lises em hor√°rios/intervalos definidos pelo usu√°rio")
    Component(threshold_monitor, "Threshold Monitor", "Python", "Monitora indicadores e valores limite configurados")
    Component(trigger_evaluator, "Trigger Evaluator", "Python", "Avalia condi√ß√µes e decide quando disparar an√°lise preditiva")
}

Container_Boundary(queue_boundary, "Fila de Eventos - Hub Central") {
    Component(sensor_queue, "Sensor Data Queue", "RabbitMQ", "Fila para dados de sensores")
    Component(anomaly_queue, "Anomaly Events Queue", "RabbitMQ", "Fila para eventos de anomalias")
    Component(prediction_queue, "Prediction Events Queue", "RabbitMQ", "Fila para eventos de predi√ß√£o")
    Component(maintenance_queue, "Maintenance Events Queue", "RabbitMQ", "Fila para eventos de manuten√ß√£o")
    Component(workorder_queue, "WorkOrder Events Queue", "RabbitMQ", "Fila para eventos de ordens de servi√ßo")
    Component(trigger_queue, "Trigger Events Queue", "RabbitMQ", "Fila para eventos de trigger configur√°vel")
}

Container_Boundary(agents_boundary, "Pipeline de Agentes AI Contextualizados") {
    Component(anomaly_detector, "Anomaly Detection Agent", "Python + LangChain + scikit-learn", "Detecta anomalias usando contexto de equipamentos")
    Component(predictive_analyzer, "Predictive Analysis Agent", "Python + LangChain + TensorFlow", "Prediz falhas usando hist√≥rico de manuten√ß√µes")
    Component(maintenance_planner, "Maintenance Planning Agent", "Python + LangChain", "Planeja manuten√ß√µes usando FMEA e manuais")
    Component(workorder_generator, "Work Order Agent", "Python + LangChain", "Gera OS usando contexto completo do equipamento")
}

Container_Boundary(rag_boundary, "RAG Service Contextualizado") {
    Component(contextual_retriever, "Contextual Retriever", "Python + LangChain", "Busca conhecimento espec√≠fico por equipamento")
    Component(manual_searcher, "Manual Searcher", "Python + LangChain", "Busca procedimentos espec√≠ficos em manuais")
    Component(fmea_searcher, "FMEA Searcher", "Python + LangChain", "Busca an√°lises FMEA relacionadas")
    Component(history_searcher, "History Searcher", "Python + LangChain", "Busca casos similares no hist√≥rico")
    Component(context_generator, "Context Generator", "Python + LangChain + Ollama", "Gera recomenda√ß√µes contextualizadas")
}

ContainerDb(postgres, "PostgreSQL", "PostgreSQL 15", "Dados mestre e operacionais")
ContainerDb(influxdb, "InfluxDB/TimescaleDB", "Time Series Database", "Hist√≥rico de sensores")
ContainerDb(pinecone, "Pinecone Vector DB", "Pinecone Cloud", "Embeddings contextuais")
ContainerDb(minio, "MinIO/S3", "Object Storage", "PDFs e documentos t√©cnicos")

Person(gestor_ativos, "Gestor de Ativos", "Cadastra dados mestre")
System_Ext(sensors, "Sensores IoT", "Dispositivos de campo")

' === FLUXOS DE GEST√ÉO DE DADOS MESTRE ===
' Equipment Management
Rel(gestor_ativos, equipment_crud, "Cadastra equipamentos", "REST API")
Rel(equipment_crud, equipment_validator, "Valida dados", "Internal")
Rel(equipment_validator, hierarchy_manager, "Valida hierarquia", "Internal")
Rel(equipment_crud, postgres, "Persiste equipamentos", "SQL")

' Sensor Management
Rel(gestor_ativos, sensor_crud, "Cadastra sensores", "REST API")
Rel(sensor_crud, sensor_validator, "Valida especifica√ß√µes", "Internal")
Rel(sensor_validator, sensor_registry, "Registra globalmente", "Internal")
Rel(sensor_crud, postgres, "Persiste sensores", "SQL")

' Manual & FMEA Management
Rel(gestor_ativos, manual_crud, "Upload manuais", "REST API")
Rel(manual_crud, document_uploader, "Upload seguro", "Internal")
Rel(document_uploader, minio, "Armazena PDFs", "S3 API")
Rel(manual_crud, fmea_manager, "Vincula FMEA", "Internal")
Rel(fmea_manager, postgres, "Persiste FMEA", "SQL")

' Document Processing Pipeline
Rel(document_uploader, pdf_processor, "Process new PDF", "Internal")
Rel(pdf_processor, text_extractor, "Extracted text", "Internal")
Rel(text_extractor, entity_recognizer, "Structured text", "Internal")
Rel(entity_recognizer, document_classifier, "Entities found", "Internal")
Rel(document_classifier, embedding_generator, "Classified content", "Internal")
Rel(embedding_generator, knowledge_indexer, "Generate embeddings", "Internal")
Rel(knowledge_indexer, pinecone, "Store embeddings", "Pinecone API")

' Maintenance History Management
Rel(gestor_ativos, maintenance_crud, "Registra manuten√ß√µes", "REST API")
Rel(maintenance_crud, failure_analyzer, "Analisa padr√µes", "Internal")
Rel(failure_analyzer, roi_calculator, "Calcula ROI", "Internal")
Rel(maintenance_crud, postgres, "Persiste hist√≥rico", "SQL")

' === FLUXO OPERACIONAL COM CONTEXTO ===
' Data Ingestion with Context
Rel(sensors, data_receiver, "Telemetria", "MQTT/HTTP")
Rel(data_receiver, sensor_validator_runtime, "Valida sensor", "Internal")
Rel(sensor_validator_runtime, sensor_registry, "Consulta registry", "Internal")
Rel(data_receiver, data_processor, "Data + context", "Internal")
Rel(data_processor, timeseries_writer, "Processed data", "Internal")
Rel(timeseries_writer, influxdb, "Store time series", "InfluxDB")

' Pipeline com Contexto Completo
Rel(sensor_queue, anomaly_detector, "Sensor data", "AMQP")
Rel(anomaly_detector, equipment_crud, "Equipment context", "REST API")
Rel(anomaly_detector, sensor_registry, "Sensor specs", "REST API")
Rel(anomaly_detector, maintenance_crud, "Historical context", "REST API")

Rel(trigger_queue, predictive_analyzer, "Trigger event", "AMQP")
Rel(predictive_analyzer, maintenance_crud, "Historical failures", "REST API")
Rel(predictive_analyzer, equipment_crud, "Equipment specs", "REST API")
Rel(predictive_analyzer, failure_analyzer, "Failure patterns", "REST API")

Rel(prediction_queue, maintenance_planner, "Prediction event", "AMQP")
Rel(maintenance_planner, contextual_retriever, "Query knowledge", "HTTP")
Rel(contextual_retriever, manual_searcher, "Search manuals", "Internal")
Rel(contextual_retriever, fmea_searcher, "Search FMEA", "Internal")
Rel(contextual_retriever, history_searcher, "Search similar cases", "Internal")
Rel(manual_searcher, pinecone, "Vector search manuals", "Pinecone API")
Rel(fmea_searcher, pinecone, "Vector search FMEA", "Pinecone API")
Rel(history_searcher, postgres, "Search history", "SQL")

Rel(maintenance_queue, workorder_generator, "Maintenance event", "AMQP")
Rel(workorder_generator, equipment_crud, "Equipment hierarchy", "REST API")
Rel(workorder_generator, maintenance_crud, "Log new maintenance", "REST API")
Rel(workorder_generator, roi_calculator, "Calculate expected ROI", "REST API")

note right of equipment_crud
Equipment Management:

üè≠ HIERARQUIA COMPLEXA:
- Plantas ‚Üí Linhas ‚Üí Equipamentos ‚Üí Componentes
- Relacionamentos parent/child
- Heran√ßa de configura√ß√µes
- Criticidade por n√≠vel
- Planos de manuten√ß√£o cascata

üìä ESPECIFICA√á√ïES T√âCNICAS:
- Fabricante, modelo, s√©rie
- Par√¢metros operacionais
- Limites de alarme
- Vida √∫til esperada
- Pe√ßas de reposi√ß√£o
end note

note right of sensor_registry
Sensor Registry:

üîç REUTILIZA√á√ÉO INTELIGENTE:
- Cat√°logo global de tipos de sensor
- Especifica√ß√µes t√©cnicas padronizadas
- Configura√ß√µes testadas e aprovadas
- Limites operacionais por aplica√ß√£o
- Hist√≥rico de performance

üì° VALIDA√á√ÉO AUTOM√ÅTICA:
- Verifica√ß√£o de compatibilidade
- Valida√ß√£o de ranges operacionais
- Detec√ß√£o de configura√ß√µes inv√°lidas
- Sugest√µes de melhorias
- Alertas de descontinua√ß√£o
end note

note right of fmea_manager
FMEA Integration:

‚ö†Ô∏è AN√ÅLISE SISTEM√ÅTICA:
- Modos de falha por componente
- Efeitos e severidade
- Probabilidade de ocorr√™ncia
- M√©todos de detec√ß√£o
- A√ß√µes recomendadas

üîó LINKING INTELIGENTE:
- Vincula√ß√£o com equipamentos
- Correla√ß√£o com hist√≥rico
- Prioriza√ß√£o autom√°tica
- Updates baseados em dados reais
- Feedback loop cont√≠nuo
end note

note right of contextual_retriever
RAG Contextualizado:

üß† BUSCA INTELIGENTE:
- Contexto por equipamento espec√≠fico
- Filtragem por tipo de falha
- Peso por relev√¢ncia hist√≥rica
- Multi-fonte (manuais + FMEA + hist√≥rico)
- Recomenda√ß√µes personalizadas

üìö KNOWLEDGE FUSION:
- Combina m√∫ltiplas fontes
- Resolve conflitos automaticamente
- Atualiza conhecimento continuamente
- Aprende com feedback
- Multilingual support
end note

SHOW_LEGEND()
@enduml