@startuml C2-Containers-Nexora
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Diagrama de Containers - Plataforma SaaS Nexora com Gest√£o de Dados Mestre

Person(usuario, "Usu√°rio", "T√©cnicos de manuten√ß√£o, gestores de ativos e operadores")
Person(admin, "Admin/Configurador", "Configura triggers de an√°lise preditiva")
Person(gestor_ativos, "Gestor de Ativos", "Cadastra equipamentos, sensores e manuais")

System_Boundary(nexora_boundary, "Plataforma SaaS Nexora") {
    Container(web_app, "Aplica√ß√£o Web", "React + TypeScript", "Interface de usu√°rio para monitoramento, dashboards e configura√ß√£o de triggers")
    Container(api_gateway, "API Gateway", "Kong/Nginx", "Ponto de entrada unificado, autentica√ß√£o e roteamento de requisi√ß√µes")
    
    ' === NOVOS COMPONENTES DE GEST√ÉO DE DADOS ===
    Container(equipment_service, "Equipment Management Service", "Python + FastAPI", "CRUD de equipamentos, hierarquia e classifica√ß√£o")
    Container(sensor_service, "Sensor Management Service", "Python + FastAPI", "CRUD de sensores, tipos e especifica√ß√µes")
    Container(manual_service, "Manual & Documentation Service", "Python + FastAPI", "CRUD de manuais, procedimentos e FMEA")
    Container(maintenance_history_service, "Maintenance History Service", "Python + FastAPI", "Hist√≥rico completo de manuten√ß√µes e falhas")
    Container(document_processor, "Document Processor", "Python + LangChain", "Processa PDFs, extrai texto e gera embeddings")
    
    Container(data_ingestion, "Entrada no Sistema", "Python/FastAPI", "Recebe e processa dados de sensores IoT")
    Container(observer, "Observador", "Python", "Observa mudan√ßas e emite eventos para coordena√ß√£o")
    Container(event_queue, "Fila de Eventos", "RabbitMQ", "Hub central de coordena√ß√£o entre agentes AI")
    
    Container(trigger_manager, "Trigger Manager", "Python + Celery", "Gerencia triggers configur√°veis para an√°lise preditiva")
    
    Container(anomaly_agent, "Agent Detec√ß√£o Anomalias", "Python + LangChain", "Detecta padr√µes an√¥malos em dados de sensores")
    Container(predictive_agent, "Agent An√°lise Preditiva", "Python + LangChain", "Prediz falhas (acionado sob demanda via triggers)")
    Container(maintenance_agent, "Agent Necessidades Manuten√ß√£o", "Python + LangChain", "Identifica necessidades de manuten√ß√£o")
    Container(workorder_agent, "Agent Emiss√£o OS", "Python + LangChain", "Gera ordens de servi√ßo priorizadas")
    
    Container(rag_service, "RAG Service", "Python + LangChain", "Retrieval-Augmented Generation para recomenda√ß√µes inteligentes")
    Container(internal_tools, "Tools Internas", "Python", "Ferramentas que n√£o acessam sistemas externos")
    Container(docker_mcp_gateway, "Docker MCP Gateway", "Docker MCP Server", "Controla ferramentas que acessam sistemas externos")
    
    Container(monitoring, "Observabilidade", "Prometheus/Grafana/Jaeger", "Coleta de m√©tricas, logs e traces distribu√≠dos")
}

ContainerDb(postgres, "Banco Principal", "PostgreSQL", "Dados operacionais, equipamentos, sensores, manuais e configura√ß√µes")
ContainerDb(timeseries_db, "Banco Time Series", "InfluxDB/TimescaleDB", "Armazena hist√≥rico de dados de sensores para an√°lise preditiva")
ContainerDb(vector_db, "Vector Database", "Pinecone", "Embeddings de manuais, FMEA e dados hist√≥ricos para IA")
ContainerDb(cache, "Cache", "Redis", "Cache de sess√µes e dados frequentemente acessados")
ContainerDb(file_storage, "File Storage", "MinIO/S3", "Armazenamento de PDFs, imagens e documentos t√©cnicos")

System_Ext(sensores, "Sensores IoT", "Dispositivos de monitoramento")
System_Ext(erp, "Sistemas ERP", "SAP, Oracle, outros ERPs")
System_Ext(notificacoes, "Servi√ßos de Notifica√ß√£o", "WhatsApp, Email, SMS")

' === FLUXOS DE GEST√ÉO DE DADOS MESTRE ===
Rel(gestor_ativos, web_app, "Cadastra equipamentos e sensores", "HTTPS")
Rel(web_app, api_gateway, "CRUD operations", "HTTPS")
Rel(api_gateway, equipment_service, "Equipment CRUD", "HTTP")
Rel(api_gateway, sensor_service, "Sensor CRUD", "HTTP")
Rel(api_gateway, manual_service, "Manual CRUD", "HTTP")
Rel(api_gateway, maintenance_history_service, "History CRUD", "HTTP")

' Persist√™ncia dos dados mestre
Rel(equipment_service, postgres, "Equipment data", "SQL")
Rel(sensor_service, postgres, "Sensor data", "SQL")
Rel(manual_service, postgres, "Manual metadata", "SQL")
Rel(manual_service, file_storage, "PDF/Documents", "S3 API")
Rel(maintenance_history_service, postgres, "History data", "SQL")

' Processamento de documentos para RAG
Rel(manual_service, document_processor, "Process new documents", "HTTP")
Rel(document_processor, file_storage, "Read PDFs", "S3 API")
Rel(document_processor, rag_service, "Extract and index", "HTTP")
Rel(rag_service, vector_db, "Store embeddings", "Pinecone API")

' Fluxo de Configura√ß√£o de Triggers
Rel(admin, web_app, "Configura triggers de an√°lise", "HTTPS")
Rel(web_app, api_gateway, "API de configura√ß√£o", "HTTPS")
Rel(api_gateway, trigger_manager, "Salva configura√ß√µes", "HTTP")
Rel(trigger_manager, postgres, "Armazena triggers", "SQL")

' Fluxo Pipeline Sequencial
Rel(sensores, data_ingestion, "Envia telemetria", "MQTT/HTTP")
Rel(data_ingestion, sensor_service, "Valida sensor registration", "HTTP")
Rel(data_ingestion, timeseries_db, "Armazena dados tratados", "SQL/Line Protocol")
Rel(data_ingestion, observer, "Dados processados", "HTTP")
Rel(observer, event_queue, "Emite eventos", "AMQP")

' Trigger Logic
Rel(event_queue, trigger_manager, "Monitora dados para triggers", "AMQP")
Rel(trigger_manager, postgres, "Consulta configura√ß√µes", "SQL")
Rel(trigger_manager, timeseries_db, "Avalia thresholds", "SQL/InfluxQL")
Rel(trigger_manager, event_queue, "Dispara an√°lise preditiva", "AMQP")

' Pipeline de Agentes com acesso aos dados mestre
Rel(event_queue, anomaly_agent, "Evento: sensor_data", "AMQP")
Rel(anomaly_agent, timeseries_db, "Consulta hist√≥rico", "SQL/InfluxQL")
Rel(anomaly_agent, equipment_service, "Equipment specs", "HTTP")
Rel(anomaly_agent, sensor_service, "Sensor specs", "HTTP")
Rel(anomaly_agent, event_queue, "Evento: anomaly_detected (se cr√≠tica)", "AMQP")

Rel(event_queue, predictive_agent, "Evento: trigger_analysis", "AMQP")
Rel(predictive_agent, timeseries_db, "Consulta s√©ries temporais", "SQL/InfluxQL")
Rel(predictive_agent, maintenance_history_service, "Historical failures", "HTTP")
Rel(predictive_agent, equipment_service, "Equipment context", "HTTP")
Rel(predictive_agent, event_queue, "Evento: failure_predicted", "AMQP")

Rel(event_queue, maintenance_agent, "Evento: failure_predicted", "AMQP")
Rel(maintenance_agent, rag_service, "Consulta conhecimento", "HTTP")
Rel(maintenance_agent, equipment_service, "Equipment details", "HTTP")
Rel(maintenance_agent, maintenance_history_service, "Similar cases", "HTTP")
Rel(maintenance_agent, event_queue, "Evento: maintenance_needed", "AMQP")

Rel(event_queue, workorder_agent, "Evento: maintenance_needed", "AMQP")
Rel(workorder_agent, equipment_service, "Equipment hierarchy", "HTTP")
Rel(workorder_agent, maintenance_history_service, "Log maintenance", "HTTP")

' RAG e Tools
Rel(maintenance_agent, rag_service, "Consulta conhecimento", "HTTP")
Rel(rag_service, vector_db, "Busca similaridade", "Pinecone API")
Rel(workorder_agent, internal_tools, "Usa tools internas", "HTTP")
Rel(workorder_agent, docker_mcp_gateway, "Usa tools externas", "MCP Protocol")

' MCP Gateway - apenas sistemas externos
Rel(docker_mcp_gateway, erp, "Integra√ß√£o ERP segura", "REST/SOAP")
Rel(docker_mcp_gateway, notificacoes, "Notifica√ß√µes seguras", "REST API")

' Acesso direto para sistemas internos
Rel(maintenance_agent, postgres, "Consulta equipamentos", "SQL")
Rel(workorder_agent, postgres, "Cria ordens de servi√ßo", "SQL")

' Interface usu√°rio
Rel(usuario, web_app, "Acessa dashboards", "HTTPS")
Rel(web_app, api_gateway, "Requisi√ß√µes API", "HTTPS")
Rel(api_gateway, postgres, "Consulta dados", "SQL")
Rel(api_gateway, timeseries_db, "Consulta m√©tricas", "SQL/InfluxQL")
Rel(api_gateway, cache, "Cache dados", "Redis Protocol")

' Monitoramento e Custos
Rel(monitoring, event_queue, "Monitora eventos", "HTTP")
Rel(monitoring, timeseries_db, "Coleta m√©tricas", "InfluxQL")
Rel(monitoring, trigger_manager, "Monitora custos e usage", "HTTP")
Rel(predictive_agent, postgres, "Log de custos LLM", "SQL")

note as trigger_options
Op√ß√µes de Trigger Configur√°veis:

üïê AN√ÅLISE AGENDADA:
- Intervalo fixo (6h, 12h, di√°rio, semanal)
- Hor√°rios espec√≠ficos (8h, 14h, 20h)
- Dias da semana personalizados
- Fuso hor√°rio configur√°vel
- Budget limits por per√≠odo

üìä BASEADA EM INDICADORES:
- Thresholds por sensor (temp > 80¬∞C)
- Varia√ß√µes percentuais (+15% da m√©dia)
- Combina√ß√µes l√≥gicas (temp AND vibra√ß√£o)
- Desvio padr√£o configur√°vel (2œÉ, 3œÉ)
- Cooldown period (evita spam)
- Anomalias cr√≠ticas (bypass sempre)
end note

note as cost_control
Controle de Custos SaaS:
- Usage tracking por tenant
- Budget limits configur√°veis
- Rate limiting baseado em plano
- An√°lise sob demanda reduz custos
- Cost allocation transparente
- Alertas de budget pr√≥ximo do limite
end note

note as scalability_note
Escalabilidade e Performance:
- Agent Preditiva roda apenas quando necess√°rio
- Trigger Manager distribui carga inteligentemente
- Cache de resultados de an√°lise
- Batch processing para m√∫ltiplos equipamentos
- Queue priority para an√°lises cr√≠ticas
- Multi-tenant isolation
end note

note as data_master_note
Gest√£o de Dados Mestre:

üìã EQUIPAMENTOS:
- Hierarquia (Planta ‚Üí Linha ‚Üí Equipamento)
- Especifica√ß√µes t√©cnicas
- Criticidade e classifica√ß√£o
- Relacionamento com sensores
- Planos de manuten√ß√£o padr√£o

üîç SENSORES:
- Tipos e especifica√ß√µes
- Limites operacionais normais
- Configura√ß√µes de alarme
- Hist√≥rico de instala√ß√£o
- Reutiliza√ß√£o entre equipamentos

üìö MANUAIS & FMEA:
- PDFs processados automaticamente
- Embeddings para RAG
- Procedimentos por tipo de falha
- FMEA (Failure Mode Effect Analysis)
- Knowledge base contextualizada
end note

note as maintenance_history_note
Hist√≥rico de Manuten√ß√µes:

üîß REGISTROS COMPLETOS:
- Tipos de manuten√ß√£o (preventiva, corretiva, preditiva)
- Pe√ßas utilizadas e custos
- Tempo de execu√ß√£o (MTTR)
- Efic√°cia das predi√ß√µes
- Feedback dos t√©cnicos

üìä AN√ÅLISE DE PADR√ïES:
- Modos de falha recorrentes
- Sazonalidade de problemas
- Correla√ß√µes entre equipamentos
- ROI das manuten√ß√µes
- Trending de degrada√ß√£o
end note

note as document_processing_note
Processamento de Documentos:

ü§ñ AUTOMA√á√ÉO COMPLETA:
- OCR para PDFs escaneados
- Extra√ß√£o de procedimentos
- Identifica√ß√£o de pe√ßas/ferramentas
- Linking com equipamentos
- Versionamento de manuais

üß† RAG INTELIGENTE:
- Embeddings contextuais por equipamento
- Busca sem√¢ntica avan√ßada
- Recomenda√ß√µes personalizadas
- Atualiza√ß√£o autom√°tica da knowledge base
- Multi-idioma (PT/EN/ES)
end note

SHOW_LEGEND()
@enduml